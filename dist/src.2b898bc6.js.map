{"version":3,"sources":["src/index.js"],"names":["Barrage","canvas","document","querySelector","height","documentElement","clientHeight","width","clientWidth","rect","getBoundingClientRect","w","right","left","h","bottom","top","ctx","getContext","font","barrageList","text","color","getTop","offset","getOffset","Math","ceil","measureText","barrage","value","push","length","clearRect","i","b","splice","drawText","requestAnimationFrame","draw","bind","fillStyle","fillText","floor","random","toFixed","lucky","luckyWrapper","window","addEventListener","e","target","className","style","display","innerHTML","TIMEOUTTIME","INTERVALTIME","fakeBadUsernames","shuffle","arr","input","randomIndex","itemAtIndex","showLucky","luckyUsers","badUsernames","console","log","map","join","names","Array","from","querySelectorAll","interval","setInterval","name","innerText","timeout","setTimeout","headImgUrl","nickname","clearInterval","clearTimeout","ws","WebSocket","onopen","send","onmessage","t","JSON","parse","data","status","shoot","onclose"],"mappings":"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","file":"src.2b898bc6.js","sourceRoot":"../screen","sourcesContent":["import './css.css'\n\nclass Barrage {\n  constructor(canvas) {\n    this.canvas = document.querySelector(canvas)\n    const height = document.documentElement.clientHeight\n    const width = document.documentElement.clientWidth\n    this.canvas.height = height\n    this.canvas.width = width\n\n    const rect = this.canvas.getBoundingClientRect();\n    this.w = rect.right - rect.left;\n    this.h = rect.bottom - rect.top;\n    this.ctx = this.canvas.getContext('2d');\n    this.ctx.font = '50px Microsoft YaHei';\n    this.barrageList = [];\n  }\n\n  //添加弹幕列表\n  shoot({ text, color }) {\n    let top = this.getTop();\n    let offset = this.getOffset();\n    let width = Math.ceil(this.ctx.measureText(text).width);\n    let barrage = {\n      value: text,\n      top,\n      left: this.w,\n      color,\n      offset,\n      width,\n    }\n    this.barrageList.push(barrage);\n  }\n\n  //开始绘制\n  draw() {\n    if (this.barrageList.length) {\n      this.ctx.clearRect(0, 0, this.w, this.h);\n      for (let i = 0; i < this.barrageList.length; i++) {\n        let b = this.barrageList[i];\n        if (b.left + b.width <= 0) {\n          this.barrageList.splice(i, 1);\n          i--;\n          continue;\n        }\n        b.left -= b.offset;\n        this.drawText(b);\n      }\n    }\n    requestAnimationFrame(this.draw.bind(this));\n  }\n\n  //绘制文字\n  drawText(barrage) {\n    this.ctx.fillStyle = barrage.color;\n    this.ctx.fillText(barrage.value, barrage.left, barrage.top);\n  }\n\n  //获取随机top\n  getTop() {\n    //canvas绘制文字x,y坐标是按文字左下角计算，预留30px\n    return Math.floor(Math.random() * (this.h - 50)) + 50;\n  }\n\n  //获取偏移量\n  getOffset() {\n    return +(Math.random() * 2).toFixed(1) + 2;\n  }\n}\n\nlet barrage = new Barrage('canvas')\nbarrage.draw()\n\nconst lucky = document.querySelector('.lucky')\nconst luckyWrapper = document.querySelector('.lucky-wrapper')\n\nwindow.addEventListener('click', e => {\n  if (e.target.className === 'screen') {\n    lucky.style.display = 'none'\n    luckyWrapper.innerHTML = ''\n  }\n})\n\nconst TIMEOUTTIME = 5000\nconst INTERVALTIME = 100\n\nconst fakeBadUsernames = [\n  'ahabhgk',\n  'sajo',\n  'sudo rm -rf /*',\n  '仰望',\n  '锅',\n  '孤雏',\n  'Nickdue',\n  'ShallowDream',\n  '复读机',\n  '封瑟',\n  'Ryan',\n  '青山',\n  '瞳根',\n  '还原型辅酶Ⅱ',\n  '风华学月wsm',\n  '℡★魅G↘纷飛',\n  '枉久',\n  'Neko',\n  'Deep memory',\n  'flower',\n  '黑白先生',\n  'Huayra的轮胎',\n  'Isolation',\n  '霜天に坐せ',\n  '君爱卿',\n  'Kirito',\n  'Kennard',\n  'lyna tlncgbnn',\n  'Los Unidades',\n  'Phosphorite',\n  '青笙挽歌',\n  '柒千零四十五',\n  '浅夏_流年',\n  '前世迟来者.',\n  '逝风而去',\n  'Even You',\n]\n\nfunction shuffle(arr) {\n  var input = [...arr];\n\n  for (var i = input.length-1; i >=0; i--) {\n    var randomIndex = Math.floor(Math.random()*(i+1));\n    var itemAtIndex = input[randomIndex];\n\n    input[randomIndex] = input[i];\n    input[i] = itemAtIndex;\n  }\n  return input;\n}\n\nconst showLucky = (luckyUsers, badUsernames = shuffle(fakeBadUsernames)) => {\n  console.log(luckyUsers)\n  luckyWrapper.innerHTML = luckyUsers.map(() => `\n    <div class=\"lucky-info\">\n      <div class=\"avatar\">?</div>\n      <div class=\"name\"> </div>\n    </div>\n  `).join('')\n\n  lucky.style.display = 'block'\n\n  const names = Array.from(document.querySelectorAll('.name'))\n  const interval = setInterval(() => {\n    names.map(name => {\n      name.innerText = badUsernames[Math.floor(Math.random() * badUsernames.length)]\n    })\n  }, INTERVALTIME)\n\n  const timeout = setTimeout(() => {\n    luckyWrapper.innerHTML = luckyUsers.map(({ headImgUrl, nickname }) => `\n      <div class=\"lucky-info\">\n        <div class=\"avatar\" style=\"background-image: url(${headImgUrl})\"></div>\n        <div class=\"name\">${nickname}</div>\n      </div>\n    `).join('')\n\n    clearInterval(interval)\n    clearTimeout(timeout)\n  }, TIMEOUTTIME)\n}\n\nconst ws = new WebSocket('wss://be-prod.redrock.cqupt.edu.cn/another_barrage/screen/barrage')\n\nws.onopen = e => {\n  console.log(\"Connection open ...\")\n  ws.send(\"Hello WebSockets!\")\n\n  setInterval(() => {\n    ws.send('keepOnline')\n    console.log('keepOnline')\n  }, 29000)\n}\n\nws.onmessage = e => {\n  const t = JSON.parse(e.data)\n\n  if (!t.status) {\n    console.log(t)\n    barrage.shoot(t)\n    return\n  }\n\n  showLucky(t.data)\n}\n\nws.onclose = e => console.log(\"Connection closed.\")\n"]}